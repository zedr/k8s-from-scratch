---
- hosts: k8s
  vars:
    runc_version: "1.0.0-rc92"
    arch: amd64
    go_version: "1.15.6"
  tasks:

    - name: Install runc build dependencies
      yum:
        name:
          - "@development"
          - libseccomp-devel

    - set_fact:
        _arch: "armv6l"
      when: arch == "arm"

    - set_fact:
        _arch: "amd64"
      when: arch == "amd64"

    - name: Download golang runtime
      unarchive:
        src: "https://golang.org/dl/go{{ go_version }}.linux-{{ _arch }}.tar.gz"
        remote_src: yes
        dest: "/opt/"
        creates: "/opt/go/"
    
    - name: Include go binaries in PATH
      blockinfile:
        path: "/etc/profile.d/opt-golang.sh"
        create: yes
        content: |
          export PATH=$PATH:/opt/go/bin

    - name: "Checkout the runc codebase at version {{ runc_version }}"
      git:
        repo: "https://github.com/opencontainers/runc.git"
        dest: "{{ ansible_env.HOME}}/src/runc"
        version: "v{{ runc_version }}"
        update: no

    - name: Build runc
      command:
        chdir: "{{ ansible_env.HOME}}/src/runc"
        cmd: make
        creates: "{{ ansible_env.HOME}}/src/runc/runc"
      register: make_result

    - copy:
        src: "{{ ansible_env.HOME}}/src/runc/runc"
        remote_src:  yes
        dest: /usr/local/bin/runc
        mode: 0755



